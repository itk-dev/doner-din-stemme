# Giv din stemme

[![Woodpecker](https://img.shields.io/badge/woodpecker-prod|stg-blue.svg?style=flat-square&logo=data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PHBhdGggZmlsbD0iI2ZmZiIgZD0iTTEuMjYzIDIuNzQ0QzIuNDEgMy44MzIgMi44NDUgNC45MzIgNC4xMTggNS4wOGwuMDM2LjAwN2MtLjU4OC42MDYtMS4wOSAxLjQwMi0xLjQ0MyAyLjQyMy0uMzggMS4wOTYtLjQ4OCAyLjI4NS0uNjE0IDMuNjU5LS4xOSAyLjA0Ni0uNDAxIDQuMzY0LTEuNTU2IDcuMjY5LTIuNDg2IDYuMjU4LTEuMTIgMTEuNjMuMzMyIDE3LjMxNy42NjQgMi42MDQgMS4zNDggNS4yOTcgMS42NDIgOC4xMDdhLjg1Ny44NTcgMCAwMC42MzMuNzQ0Ljg2Ljg2IDAgMDAuOTIyLS4zMjNjLjIyNy0uMzEzLjUyNC0uNzk3Ljg2LTEuNDI0Ljg0IDMuMzIzIDEuMzU1IDYuMTMgMS43ODMgOC42OTdhLjg2Ni44NjYgMCAwMDEuNTE3LjQxYzIuODgtMy40NjMgMy43NjMtOC42MzYgMi4xODQtMTIuNjc0LjQ1OS0yLjQzMyAxLjQwMi00LjQ1IDIuMzk4LTYuNTgzLjUzNi0xLjE1IDEuMDgtMi4zMTggMS41NS0zLjU2Ni4yMjgtLjA4NC41NjktLjMxNC43OS0uNDQxbDEuNzA3LS45ODEtLjI1NiAxLjA1MmEuODY0Ljg2NCAwIDAwMS42NzguNDA4bC42OC0yLjg1OCAxLjI4NS0yLjk1YS44NjMuODYzIDAgMTAtMS41ODEtLjY4N2wtMS4xNTIgMi42NjktMi4zODMgMS4zNzJhMTguOTcgMTguOTcgMCAwMC41MDgtMi45ODFjLjQzMi00Ljg2LS43MTgtOS4wNzQtMy4wNjYtMTEuMjY2LS4xNjMtLjE1Ny0uMjA4LS4yODEtLjI0Ny0uMjYuMDk1LS4xMi4yNDktLjI2LjM1OC0uMzc0IDIuMjgzLTEuNjkzIDYuMDQ3LS4xNDcgOC4zMTkuNzUuNTg5LjIzMi44NzYtLjMzNy4zMTYtLjY3LTEuOTUtMS4xNTMtNS45NDgtNC4xOTYtOC4xODgtNi4xOTMtLjMxMy0uMjc1LS41MjctLjYwNy0uODktLjkxM0M5LjgyNS41NTUgNC4wNzIgMy4wNTcgMS4zNTUgMi41NjljLS4xMDItLjAxOC0uMTY2LjEwMy0uMDkyLjE3NW0xMC45OCA1Ljg5OWMtLjA2IDEuMjQyLS42MDMgMS44LTEgMi4yMDgtLjIxNy4yMjQtLjQyNi40MzYtLjUyNC43MzgtLjIzNi43MTQuMDA4IDEuNTEuNjYgMi4xNDMgMS45NzQgMS44NCAyLjkyNSA1LjUyNyAyLjUzOCA5Ljg2LS4yOTEgMy4yODgtMS40NDggNS43NjMtMi42NzEgOC4zODUtMS4wMzEgMi4yMDctMi4wOTYgNC40ODktMi41NzcgNy4yNTlhLjg1My44NTMgMCAwMC4wNTYuNDhjMS4wMiAyLjQzNCAxLjEzNSA2LjE5Ny0uNjcyIDkuNDZhOTYuNTg2IDk2LjU4NiAwIDAwLTEuOTctOC43MTFjMS45NjQtNC40ODggNC4yMDMtMTEuNzUgMi45MTktMTcuNjY4LS4zMjUtMS40OTctMS4zMDQtMy4yNzYtMi4zODctNC4yMDctLjIwOC0uMTgtLjQwMi0uMjM3LS40OTUtLjE2Ny0uMDg0LjA2LS4xNTEuMjM4LS4wNjIuNDQ0LjU1IDEuMjY2Ljg3OSAyLjU5OSAxLjIyNiA0LjI3NiAxLjEyNSA1LjQ0My0uOTU2IDEyLjQ5LTIuODM1IDE2Ljc4MmwtLjExNi4yNTktLjQ1Ny45ODJjLS4zNTYtMi4wMTQtLjg1LTMuOTUtMS4zMy01Ljg0LTEuMzgtNS40MDYtMi42OC0xMC41MTUtLjQwMS0xNi4yNTQgMS4yNDctMy4xMzcgMS40ODMtNS42OTIgMS42NzItNy43NDYuMTE2LTEuMjYzLjIxNi0yLjM1NS41MjYtMy4yNTIuOTA1LTIuNjA1IDMuMDYyLTMuMTc4IDQuNzQ0LTIuODUyIDEuNjMyLjMxNiAzLjI0IDEuNTkzIDMuMTU2IDMuNDJ6bS0yLjg2OC42MmExLjE3NyAxLjE3NyAwIDEwLjczNi0yLjIzNiAxLjE3OCAxLjE3OCAwIDEwLS43MzYgMi4yMzd6Ii8+PC9zdmc+Cg==)](https://woodpecker.itkdev.dk/repos/8)
[![GitHub Release](https://img.shields.io/github/v/release/itk-dev/doner-din-stemme?style=flat-square&logo=data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NDggNTEyIj48IS0tIUZvbnQgQXdlc29tZSBGcmVlIDYuNy4yIGJ5IEBmb250YXdlc29tZSAtIGh0dHBzOi8vZm9udGF3ZXNvbWUuY29tIExpY2Vuc2UgLSBodHRwczovL2ZvbnRhd2Vzb21lLmNvbS9saWNlbnNlL2ZyZWUgQ29weXJpZ2h0IDIwMjUgRm9udGljb25zLCBJbmMuLS0+PHBhdGggZmlsbD0iI2ZmZiIgZD0iTTAgODBMMCAyMjkuNWMwIDE3IDYuNyAzMy4zIDE4LjcgNDUuM2wxNzYgMTc2YzI1IDI1IDY1LjUgMjUgOTAuNSAwTDQxOC43IDMxNy4zYzI1LTI1IDI1LTY1LjUgMC05MC41bC0xNzYtMTc2Yy0xMi0xMi0yOC4zLTE4LjctNDUuMy0xOC43TDQ4IDMyQzIxLjUgMzIgMCA1My41IDAgODB6bTExMiAzMmEzMiAzMiAwIDEgMSAwIDY0IDMyIDMyIDAgMSAxIDAtNjR6Ii8+PC9zdmc+)](https://github.com/itk-dev/doner-din-stemme/releases)
[![GitHub Actions Workflow Status](https://img.shields.io/github/actions/workflow/status/itk-dev/doner-din-stemme/pr.yml?style=flat-square&logo=github)](https://github.com/itk-dev/doner-din-stemme/actions/workflows/pr.yml)
[![Codecov](https://img.shields.io/codecov/c/github/itk-dev/doner-din-stemme?style=flat-square&logo=codecov)](https://codecov.io/gh/itk-dev/doner-din-stemme)
[![GitHub last commit](https://img.shields.io/github/last-commit/itk-dev/doner-din-stemme?style=flat-square)](https://github.com/itk-dev/doner-din-stemme/commits/develop/)
[![GitHub License](https://img.shields.io/github/license/itk-dev/doner-din-stemme?style=flat-square)](https://github.com/itk-dev/doner-din-stemme/blob/develop/LICENSE)

## Local development

This project contains a docker compose setup build around [https://github.com/itk-dev/devops_itkdev-docker](https://github.com/itk-dev/devops_itkdev-docker)
which is a simple wrapper script around docker compose using [traefik](https://traefik.io/traefik/) as a revers proxy
to get FQDN to access the site.

If you do not want to use this wrapper, you can substitute the `itkdev-docer-compose` command with normal
`docker compose` remembering to load the right composer file using the `-f <file>` option.

This setup also assumes that you have a docker network shared with treafik, if you are not using the wrapper, use this
command to create the network first.

```shell
docker network create --driver=bridge --attachable --internal=false frontend
```

### Building assets for the frontend

Run the following to install dependencies with yarn.

```shell name="assets-install"
docker compose run --rm node yarn install
```

Run the following to continuously build assets upon file changes.

```shell name="assets-watch"
docker compose run --rm node yarn watch
```

Run the following to build assets once.

```shell name="assets-build"
docker compose run --rm node yarn build
```

## Build assets for Giv Din Stemme module

Run the following to install dependencies with yarn.

```shell name="gds-assets-install"
docker compose run --rm node yarn --cwd web/modules/custom/giv_din_stemme/ install
```

Run the following to continuously build assets upon file changes.

```shell name="gds-assets-watch"
docker compose run --rm node yarn --cwd web/modules/custom/giv_din_stemme/ watch
```

Run the following to build assets once.

```shell name="gds-assets-build"
docker compose run --rm node yarn --cwd web/modules/custom/giv_din_stemme/ build
```

### Site installation

Run the following commands to set up the site. This will run a normal Drupal site installation with the existing
configuration that comes with this project.

```shell name="site-up"
itkdev-docker-compose up --detach
itkdev-docker-compose composer install
itkdev-docker-compose drush site-install --existing-config --yes
```

When the installation is completed, that admin user is created and the password for logging in the outputted. If you
forget the password, use drush uli command to get a one-time-login link (not the uri here only works if you are using
trafik).

```shell name="site-login"
itkdev-docker-compose drush --uri="https://givdinstemme.local.itkdev.dk/" user:login
```

### Access the site

If you are using out `itkdev-docker-compose` simple use the command below to åbne the site in you default browser.

```shell name="site-open"
itkdev-docker-compose open
```

Alternatively you can find the port number that is mapped nginx container that server the site at `http://0.0.0.0:PORT`
by using this command:

```shell
open "http://$(docker compose port nginx 8080)"
```

### Additional microphone permissions

Some browsers on some platforms require additional microphone permissions to allow use of the microphone on all pages of
a site.

We use a regular expression to detect [Safari on iOS](https://apps.apple.com/no/app/safari/id1146562112) based on the
user agent string (cf. `Drupal\giv_din_stemme\Controller\GivDinStemmeController::test()`).

During testing and development the regular expression can easily be changed in `settings.local.php`, e.g.:

```php
# settings.local.php
// The default value matching iPhone and Safari (in any order and ignoring case)
$settings['giv_din_stemme']['requires_additional_microphone_permissions_pattern'] = '/^(?=.*\biPhone\b)(?=.*\bSafari\b).*$/i';

// Match any user agent string
$settings['giv_din_stemme']['requires_additional_microphone_permissions_pattern'] = '/./';
```

The actual help page for details on what actually must be done to grant the additional microphone permissions is set
under "References" on `/admin/site-setup/general`.

#### Browsers requiring additional microphone permissions

|         | Safari | Chrome | Firefox |
|--------:|:------:|--------|---------|
|     iOS | ✓      |        |         |
| Android |        |        |         |
|   macOS |        |        |         |

(The table reflects the checks currently implemented)

### Drupal config

This project uses Drupal's configuration import and export to handle configuration changes and uses the [config
ignore](https://www.drupal.org/project/config_ignore) module to protect some of the site settings form being overridden.
For local and production configuration settings that you do not want to export, please use `settings.local.php` to
override default configuration values.

Export config created from drupal:

```shell
itkdev-docker-compose drush config:export
```

Import config from config files:

```shell
itkdev-docker-compose drush config:import
```

## Production setup

@todo Write this section.

## OpenID Connect

We use the [OpenID Connect](https://www.drupal.org/project/openid_connect) for OpenID Connect.

### Development

During development, we use [OpenId Connect Server Mock](https://github.com/Soluto/oidc-server-mock) to test OpenID
Connect authentication, and this is reflected in the default OIDC configuration.

Run

```shell
itkdev-docker-compose --profile oidc up --detach
```

to start the OIDC mock along with the other stuff.

The OIDC mock uses a selfsigned `pfx` certificate for
[HTTPS](https://github.com/Soluto/oidc-server-mock?tab=readme-ov-file#https), and to make everything work during
development a little patch must be applied to [Guzzle](https://docs.guzzlephp.org/):

```shell name=guzzle-development-patch
docker compose exec phpfpm bash -c 'patch --strip=1 < patches/guzzle-with-self-signed-certificate.patch'
```

<details>
<summary>Updating the self-signed certificate</summary>

**Note**: This section is only kept as an internal note on how the self-signed certificate,
[`.docker/oidc-server-mock/cert/docker.pfx`](.docker/oidc-server-mock/cert/docker.pfx), is generated from our
self-signed development Traefik certificates. The certificate is committed to Git and should only be updated if our
Traefik certificates are ever updated.

```shell name=generate-mock-pfx-certificate
cert_path="$(dirname $(dirname $(which itkdev-docker-compose)))/traefik/ssl"
openssl pkcs12 -export -out .docker/oidc-server-mock/cert/docker.pfx -inkey $cert_path/docker.key -in $cert_path/docker.crt -passout pass:mock

openssl pkcs12 -in .docker/oidc-server-mock/cert/docker.pfx -passin pass:mock -passout pass: -info
```

</details>

### Production

For production, we override (some) OpenID Connect configuration (rather than ignoring config) in `settings.local.php`:

```php
// settings.local.php
// …

// https://idp-citizen.givdinstemme.srvitkstgweb01.itkdev.dk/.well-known/openid-configuration
$config['openid_connect.client.generic']['settings']['client_id'] = '…';
$config['openid_connect.client.generic']['settings']['client_secret'] = '…';

// Get these from your OIDC Discovery document.
$config['openid_connect.client.generic']['settings']['authorization_endpoint'] = '…';
$config['openid_connect.client.generic']['settings']['token_endpoint'] = '…';
$config['openid_connect.client.generic']['settings']['end_session_endpoint'] = '…';
```

## Whisper

The custom Giv din stemme module adds commands using
[Whisper](https://github.com/itk-dev/whipser-docker) for qualifying donations.

Qualifying is done by asking Whisper to transcribe the donation and then
comparing it to the original text, using one of three metrics.

### Similar text score

[similar_text](https://www.php.net/manual/en/function.similar-text.php) gives similarity
between two sentences as a percentage. That is, a high percentage means the sentences are similar.
See [ADR-002](/docs/adr/002-whisper-score-via-similar-text.md) for more details.

**Note**: to align with the WER and CER scores beneath, we report the complimentary,
i.e. the dissimilarity, on the list of donations.

### WER and CER

Word error rate(WER) and character error rate(CER). For more details on these, see
[itk-dev/sentence-similarity-metrics](https://github.com/itk-dev/sentence-similarity-metrics?tab=readme-ov-file#metrics).
This is a number between 0 and 1  A low score means the transcribed sentence is similar to the original one.

### Configuration

Before using the qualifying command you must configure

* Whisper API endpoint
* Whisper API key.

```php
// settings.local.php
// …

$settings['itkdev_whisper_api_endpoint'] = '…';
$settings['itkdev_whisper_api_key'] = '…';
```

See 1Password for both api endpoint and key.

### Commands

Qualify all unqualified donations with

```shell name="gds-qualify-transcribe-all-donations"
itkdev-docker-compose drush giv_din_stemme:qualify:transcribe
```

or re-qualify donations by adding the `--re-qualify` flag.

Qualify a specific donation with

```shell name="gds-qualify-transcribe-specific-donation"
itkdev-docker-compose drush giv_din_stemme:qualify:transcribe:id DONATION_ID
```

Calculate similar text score with

```shell name="gds-qualify-similar-text-score"
itkdev-docker-compose drush giv-din-stemme:qualify:similar-text-score
```

or re-calculate rates by adding the `--re-calculate` flag.

Calculate WER with

```shell name="gds-qualify-wer"
itkdev-docker-compose drush giv-din-stemme:qualify:wer
```

or re-calculate rates by adding the `--re-calculate` flag.

Calculate CER with

```shell name="gds-qualify-cer"
itkdev-docker-compose drush giv-din-stemme:qualify:cer
```

or re-calculate rates by adding the `--re-calculate` flag.

To continuously qualify donations consider running the qualifying commands
via a cronjobs.

## Coding standards

```shell name=coding-standards-composer
docker compose run --rm phpfpm composer install
docker compose run --rm phpfpm composer normalize
```

```shell name=coding-standards-php
docker compose run --rm phpfpm composer install
docker compose run --rm phpfpm composer coding-standards-apply/phpcs
docker compose run --rm phpfpm composer coding-standards-check/phpcs
```

```shell name=coding-standards-twig
docker compose run --rm phpfpm composer install
docker compose run --rm phpfpm composer coding-standards-apply/twig-cs-fixer
docker compose run --rm phpfpm composer coding-standards-check/twig-cs-fixer
```

```shell name=coding-standards-markdown
docker run --rm --volume "$PWD:/md" itkdev/markdownlint $(git ls-files *.md) --fix
docker run --rm --volume "$PWD:/md" itkdev/markdownlint $(git ls-files *.md)
```

```shell name="coding-standards-assets"
docker compose run --rm node yarn install
docker compose run --rm node yarn coding-standards-apply
docker compose run --rm node yarn coding-standards-check
```

## API

Before using the api the site owner must create a user and add an API key to
the user. Api endpoints are accessible through browser with the right user
permissions, but private file access requires an API key.

See accessible endpoints:

```shell
curl --url https://donerdinstemme.dk/jsonapi --header "api-key: <API KEY>"
```

Get recordings metadata and file relationship:

```shell
curl --url https://donerdinstemme.dk/jsonapi/gds/gds --header "api-key: <API KEY>"
```

Get file info:

```shell
curl --url https://donerdinstemme.dk/jsonapi/gds/gds/<FILE_ID>/file --header "api-key: <API KEY>"
```

### File download path

Use the file info endpoint data to construct a file path i.e.

```shell
curl --url https://donerdinstemme.dk/system/files/audio/<FILE_NAME>.wav --header "api-key: <API KEY>" > myLocalFile.wav
```
